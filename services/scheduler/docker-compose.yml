version: '3.8'

services:
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rune-scheduler
    restart: unless-stopped
    environment:
      # Database Configuration
      POSTGRES_HOST: ${POSTGRES_HOST:-db}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-rune}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      
      # RabbitMQ Configuration
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
      RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
      RABBITMQ_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-guest}
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE:-workflow_queue}
      
      # Scheduler Configuration
      SCHEDULER_POLL_INTERVAL: ${SCHEDULER_POLL_INTERVAL:-30}
      SCHEDULER_LOOK_AHEAD: ${SCHEDULER_LOOK_AHEAD:-60}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    
    networks:
      - rune-network
    
    healthcheck:
      test: ["CMD", "sh", "-c", "ps aux | grep -q '[p]ython.*scheduler.py' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  rune-network:
    external: true
