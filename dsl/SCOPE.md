# DSL Code Generator - Scope Document

This document defines which files will be generated by the DSL code generator and which files require manual updates.

## Generated Files

These files are **fully generated** from `dsl/dsl-definition.json`. Do not edit them manually - regenerate after modifying the DSL definition.

### Frontend (TypeScript)

#### ✅ `apps/web/src/lib/workflow-dsl.ts`
**Status**: Fully Generated (with manual sections preserved)

**Generated:**
- `WorkflowNode` interface
- `WorkflowEdge` interface
- `MissingNodeCredentialsError` class

**Manual (preserved with TODO comments):**
- `canvasToWorkflowData()` - ReactFlow to DSL conversion
- `workflowDataToCanvas()` - DSL to ReactFlow conversion
- `toWorkerParameters()` - Parameter mapping logic
- `nodeHydrators` - Node data hydration
- `toWorkerType()` - Type mapping function
- Helper functions (email conversion, node naming, etc.)

**Why manual**: Complex ReactFlow-specific logic that requires framework knowledge.

#### ✅ `apps/web/src/features/canvas/types.ts`
**Status**: Fully Generated (with manual sections preserved)

**Generated:**
- `NodeDataMap` type with all node data types
- `NodeKind` union type
- Individual node data types (`HttpData`, `SmtpData`, etc.)
- `SwitchRule` and `SwitchOperator` types
- `CanvasNode` type

**Manual (preserved):**
- `NODE_SCHEMA` - Hardcoded inputs/outputs (kept as-is from original)

**Why manual**: NODE_SCHEMA values are static and don't change with DSL structure.

#### ✅ `apps/web/src/lib/credentials.ts`
**Status**: Fully Generated

**Generated:**
- `CredentialRef` interface
- `NODE_TYPES_REQUIRING_CREDENTIALS` set (from DSL `requires_credentials` flag)
- `isCredentialRef()` validation function
- `nodeTypeRequiresCredential()` function

**Why generated**: Simple validation logic that can be derived from DSL definition.

### Backend (Python)

#### ✅ `services/api/src/smith/schemas.py`
**Status**: Fully Generated

**Generated:**
- `WorkflowNode` Pydantic model
- `WorkflowEdge` Pydantic model
- `Workflow` Pydantic model
- `SmithMessage` model
- `GenerateWorkflowRequest` model
- `GeneratedWorkflow` model

**Why generated**: Pure Pydantic models that directly map to DSL structures.

#### ✅ `services/api/src/workflow/schemas.py`
**Status**: Fully Generated (with manual sections preserved)

**Generated:**
- `WorkflowCreate.workflow_data` - Now typed as `Workflow`
- `WorkflowDetail.workflow_data` - Now typed as `Workflow`
- `WorkflowUpdateData.workflow_data` - Now typed as `Workflow`
- `NodeExecutionMessage.workflow_definition` - Now typed as `Workflow`

**Manual (preserved):**
- `WorkflowListItem` - API response model (not DSL-related)
- `normalize_and_validate_name()` - Business logic function
- Field validators for name fields

**Why manual**: Business logic and API-specific concerns separate from DSL.

### Worker (Go)

#### ✅ `services/rune-worker/pkg/core/node.go`
**Status**: Fully Generated (with manual methods preserved)

**Generated:**
- `Node` struct definition

**Manual (preserved):**
- `HasCredentials()` method
- `HasErrorHandling()` method

**Why manual**: Helper methods with business logic.

#### ✅ `services/rune-worker/pkg/core/workflow.go`
**Status**: Fully Generated (with manual methods preserved)

**Generated:**
- `Workflow` struct definition
- `Edge` struct definition

**Manual (preserved):**
- All helper methods (`GetNodeByID`, `GetEdgeByID`, `GetTriggerNodes`, etc.)

**Why manual**: Graph traversal and query methods with business logic.

#### ✅ `services/rune-worker/pkg/core/credentials.go`
**Status**: Fully Generated (with manual types preserved)

**Generated:**
- `Credential` struct definition

**Manual (preserved):**
- `SMTPCredentials` struct (specific credential type, not in core DSL)

**Why manual**: Type-specific credential structures are implementation details.

#### ✅ `services/rune-worker/pkg/core/error_handling.go`
**Status**: Fully Generated

**Generated:**
- `ErrorHandling` struct definition
- Error handling type constants

**Why generated**: Simple struct that directly maps to DSL.

---

## Files Requiring Manual Updates

These files **depend on DSL** but are **NOT generated** due to complexity or different concerns. When the DSL changes, these files may need manual updates.

### Frontend

#### ❌ `apps/web/src/lib/workflow-dsl.ts` (Conversion Functions)
**What to update**: See "Manual" section above
**When**: When node parameter structures change, new node types added, field names change
**How**: See `dsl/README.md` for detailed instructions

#### ❌ `apps/web/src/lib/workflows.ts`
**What to update**: Functions that use `WorkflowNode`/`WorkflowEdge` types
**When**: When DSL structure changes affect type compatibility
**How**: Check for type errors after regeneration, update function signatures if needed

#### ❌ `apps/web/src/features/canvas/FlowCanvas.tsx`
**What to update**: Uses `workflowDataToCanvas`, `graphToWorkflowData`
**When**: When conversion functions change
**How**: Usually no changes needed unless conversion function signatures change

#### ❌ `apps/web/src/app/(canvas)/create/app/page.tsx`
**What to update**: Uses `graphToWorkflowData`, `canvasToWorkflowData`
**When**: When conversion functions change
**How**: Usually no changes needed unless conversion function signatures change

### Backend

#### ❌ `services/api/src/smith/tools.py`
**What to update**: 
- `_validate()` - Workflow structure validation
- `create_node()` - Node creation with parameter validation
- `build_workflow()` - Workflow assembly

**When**: When validation rules change, new node types added, structural constraints change

**How**: 
1. Review DSL definition for validation rule changes
2. Update validation logic in `_validate()`
3. Update node creation logic if parameter schemas change

**Complexity**: Validation logic includes business rules (e.g., exactly one trigger) that can't be generated.

#### ❌ `services/api/src/smith/prompts.py`
**What to update**: `NODE_SCHEMAS` dictionary for Smith AI agent

**When**: When node parameter schemas change or new node types are added

**How**: 
1. Review DSL definition for node parameter changes
2. Update `NODE_SCHEMAS` dictionary
3. Ensure field descriptions match DSL definition

**Complexity**: AI prompt engineering requires human-readable descriptions.

#### ❌ `services/api/src/scryb/serializer.py`
**What to update**: `WorkflowSerializer` class that converts DSL to SIR format

**When**: When DSL structure changes affect serialization

**How**: 
1. Check if DSL changes affect node/edge structure
2. Update serialization logic if needed
3. Test with actual workflow data

**Complexity**: Complex transformation logic to Semantic Intermediate Representation.

#### ❌ `services/api/src/workflow/service.py`
**What to update**: Functions that manipulate `workflow_data`

**When**: When `Workflow` type structure changes

**How**: 
1. Check for type errors after regeneration
2. Update function logic if `Workflow` structure changes
3. May need to handle migration from old `dict[str, Any]` format

**Complexity**: Service layer logic with database interactions.

#### ❌ `services/api/src/db/models.py`
**What to update**: `CredentialType` enum should match DSL credential types

**When**: When new credential types are added to DSL

**How**: 
1. Check `dsl-definition.json` for credential types
2. Add missing enum values to `CredentialType`
3. Ensure enum values match DSL credential type identifiers exactly

**Why not generated**: Database model file with ORM concerns. Only enum needs manual sync.

#### ❌ `services/api/src/credentials/schemas.py`
**What to update**: Uses `CredentialType` from `db/models.py`

**When**: When `CredentialType` enum changes (see above)

**How**: Usually no direct changes needed, but depends on `CredentialType` enum being in sync

**Why not generated**: API response schemas for credential CRUD operations (different concern than DSL).

### Worker

#### ❌ All files importing `core.Node`, `core.Workflow`, etc.
**What to update**: Code that uses generated structs

**When**: When struct field names or types change

**How**: 
1. Check for compilation errors after regeneration
2. Update field access if struct fields changed
3. Update type assertions if needed

**Files affected**: See `dsl/generator/check_dependencies.py` (to be created) for complete list.

**Complexity**: Many files (28+), but changes are usually straightforward field name updates.

---

## Files NOT Related to DSL

These files are **NOT affected** by DSL changes and do not need updates:

- `apps/web/src/client/types.gen.ts` - Auto-generated from OpenAPI (updates automatically)
- `services/api/src/credentials/schemas.py` - API response schemas (different concern)
- ReactFlow UI components - Framework-specific, not DSL-related
- Node execution logic in worker - Implementation details, not DSL structure
- Database migration files - Schema changes, not DSL changes
- Test files - May need updates if DSL changes, but not generated

---

## Summary

### Generated Files (9 files)
- ✅ 3 Frontend TypeScript files
- ✅ 2 Backend Python files  
- ✅ 4 Worker Go files

### Manual Update Required (when DSL changes)
- ❌ ~10-15 files need manual review/updates
- ❌ ~28+ Worker files may need field access updates

### Not Affected
- Auto-generated files (OpenAPI)
- Framework-specific code (ReactFlow components)
- Business logic files (service layers)
- Test files (may need updates but not generated)

---

## Change Impact Matrix

| DSL Change Type | Generated Files | Manual Files | Impact Level |
|----------------|-----------------|--------------|--------------|
| Add new node type | ✅ Auto-update | ❌ Update conversion functions, validation | Medium |
| Change node parameter | ✅ Auto-update | ❌ Update conversion functions | Medium |
| Change core structure | ✅ Auto-update | ❌ Update all dependent files | High |
| Add credential type | ✅ Auto-update | ❌ Update `CredentialType` enum | Low |
| Change field name | ✅ Auto-update | ❌ Update all field access | High |
| Add new field | ✅ Auto-update | ❌ Update conversion functions | Low |

---

## See Also

- `dsl/README.md` - Complete documentation and update instructions
- `dsl/MIGRATION.md` - Migration guide from current code
- `dsl/dsl-definition.json` - Source of truth for DSL structure

